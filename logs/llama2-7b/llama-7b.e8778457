2025-05-05 21:25:00,442 - INFO - Loading model: meta-llama/Llama-2-7b-hf
2025-05-05 21:25:00,443 - INFO - Loading model from: meta-llama/Llama-2-7b-hf
Loading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards:  50%|█████     | 1/2 [00:00<00:00,  9.15it/s]Loading checkpoint shards: 100%|██████████| 2/2 [00:00<00:00, 11.03it/s]
2025-05-05 21:25:08,328 - INFO - ✔ Loaded model on cuda:1 with float16.
2025-05-05 21:25:08,328 - INFO - No pad_token found. Set pad_token = eos_token.
2025-05-05 21:25:08,330 - INFO - Loading calibration and evaluation texts...
2025-05-05 21:25:27,914 - INFO - Evaluating original model (for baseline perplexity)...
2025-05-05 21:25:55,851 - INFO - Original model perplexity on WikiText2: 5.72
2025-05-05 21:25:55,853 - INFO - Calibrating model...
2025-05-05 21:25:55,853 - INFO - Detected architecture: llama
2025-05-05 21:28:36,271 - INFO - Finished calibration and computed BI scores.
2025-05-05 21:28:36,275 - INFO - Allocating layer sparsity...
2025-05-05 21:28:36,275 - INFO - Allocating global sparsity using target keep ratio 0.5000 and temperature 1.0
2025-05-05 21:28:36,275 - INFO - Layer  0: keep_ratio = 1.0000 (BI = 0.4532)
2025-05-05 21:28:36,275 - INFO - Layer  1: keep_ratio = 0.3774 (BI = 0.3471)
2025-05-05 21:28:36,275 - INFO - Layer  2: keep_ratio = 0.4513 (BI = 0.1683)
2025-05-05 21:28:36,275 - INFO - Layer  3: keep_ratio = 0.4585 (BI = 0.1526)
2025-05-05 21:28:36,275 - INFO - Layer  4: keep_ratio = 0.4563 (BI = 0.1575)
2025-05-05 21:28:36,275 - INFO - Layer  5: keep_ratio = 0.4629 (BI = 0.1431)
2025-05-05 21:28:36,275 - INFO - Layer  6: keep_ratio = 0.4640 (BI = 0.1407)
2025-05-05 21:28:36,275 - INFO - Layer  7: keep_ratio = 0.4671 (BI = 0.1339)
2025-05-05 21:28:36,275 - INFO - Layer  8: keep_ratio = 0.4736 (BI = 0.1201)
2025-05-05 21:28:36,275 - INFO - Layer  9: keep_ratio = 0.4782 (BI = 0.1105)
2025-05-05 21:28:36,275 - INFO - Layer 10: keep_ratio = 0.4819 (BI = 0.1027)
2025-05-05 21:28:36,275 - INFO - Layer 11: keep_ratio = 0.4873 (BI = 0.0916)
2025-05-05 21:28:36,275 - INFO - Layer 12: keep_ratio = 0.4869 (BI = 0.0925)
2025-05-05 21:28:36,275 - INFO - Layer 13: keep_ratio = 0.4864 (BI = 0.0936)
2025-05-05 21:28:36,275 - INFO - Layer 14: keep_ratio = 0.4904 (BI = 0.0853)
2025-05-05 21:28:36,275 - INFO - Layer 15: keep_ratio = 0.4856 (BI = 0.0952)
2025-05-05 21:28:36,275 - INFO - Layer 16: keep_ratio = 0.4893 (BI = 0.0876)
2025-05-05 21:28:36,275 - INFO - Layer 17: keep_ratio = 0.4964 (BI = 0.0731)
2025-05-05 21:28:36,275 - INFO - Layer 18: keep_ratio = 0.4998 (BI = 0.0663)
2025-05-05 21:28:36,275 - INFO - Layer 19: keep_ratio = 0.5058 (BI = 0.0543)
2025-05-05 21:28:36,275 - INFO - Layer 20: keep_ratio = 0.5073 (BI = 0.0514)
2025-05-05 21:28:36,275 - INFO - Layer 21: keep_ratio = 0.5130 (BI = 0.0403)
2025-05-05 21:28:36,275 - INFO - Layer 22: keep_ratio = 0.5135 (BI = 0.0393)
2025-05-05 21:28:36,275 - INFO - Layer 23: keep_ratio = 0.5170 (BI = 0.0324)
2025-05-05 21:28:36,275 - INFO - Layer 24: keep_ratio = 0.5174 (BI = 0.0317)
2025-05-05 21:28:36,275 - INFO - Layer 25: keep_ratio = 0.5174 (BI = 0.0317)
2025-05-05 21:28:36,275 - INFO - Layer 26: keep_ratio = 0.5186 (BI = 0.0295)
2025-05-05 21:28:36,275 - INFO - Layer 27: keep_ratio = 0.5191 (BI = 0.0284)
2025-05-05 21:28:36,276 - INFO - Layer 28: keep_ratio = 0.5180 (BI = 0.0306)
2025-05-05 21:28:36,276 - INFO - Layer 29: keep_ratio = 0.5170 (BI = 0.0326)
2025-05-05 21:28:36,276 - INFO - Layer 30: keep_ratio = 0.4886 (BI = 0.0890)
2025-05-05 21:28:36,276 - INFO - Layer 31: keep_ratio = 0.3540 (BI = 0.4112)
2025-05-05 21:28:36,276 - INFO - Freeing original model from GPU before compression...
2025-05-05 21:28:40,288 - INFO - n_layers=32, n_heads=32, d_model=4096, head_dim=128
2025-05-05 21:28:40,288 - INFO - Applying MoDeGPT compression methods...
2025-05-05 21:31:22,854 - INFO - [MLP] Compressed layer 0 to rank 11008 (Nyström, λ=0.01)
2025-05-05 21:32:23,049 - INFO - [MLP] Compressed layer 1 to rank 4154 (Nyström, λ=0.01)
2025-05-05 21:33:28,165 - INFO - [MLP] Compressed layer 2 to rank 4968 (Nyström, λ=0.01)
2025-05-05 21:34:33,392 - INFO - [MLP] Compressed layer 3 to rank 5046 (Nyström, λ=0.01)
2025-05-05 21:35:37,399 - INFO - [MLP] Compressed layer 4 to rank 5022 (Nyström, λ=0.01)
2025-05-05 21:36:42,479 - INFO - [MLP] Compressed layer 5 to rank 5095 (Nyström, λ=0.01)
2025-05-05 21:37:47,731 - INFO - [MLP] Compressed layer 6 to rank 5107 (Nyström, λ=0.01)
2025-05-05 21:38:52,532 - INFO - [MLP] Compressed layer 7 to rank 5142 (Nyström, λ=0.01)
2025-05-05 21:39:58,634 - INFO - [MLP] Compressed layer 8 to rank 5213 (Nyström, λ=0.01)
2025-05-05 21:41:04,158 - INFO - [MLP] Compressed layer 9 to rank 5264 (Nyström, λ=0.01)
2025-05-05 21:42:08,669 - INFO - [MLP] Compressed layer 10 to rank 5305 (Nyström, λ=0.01)
2025-05-05 21:42:50,192 - INFO - [MLP] Compressed layer 11 to rank 5364 (Nyström, λ=0.01)
2025-05-05 21:43:54,884 - INFO - [MLP] Compressed layer 12 to rank 5359 (Nyström, λ=0.01)
2025-05-05 21:45:00,783 - INFO - [MLP] Compressed layer 13 to rank 5354 (Nyström, λ=0.01)
2025-05-05 21:46:08,321 - INFO - [MLP] Compressed layer 14 to rank 5398 (Nyström, λ=0.01)
2025-05-05 21:47:15,420 - INFO - [MLP] Compressed layer 15 to rank 5345 (Nyström, λ=0.01)
2025-05-05 21:48:23,078 - INFO - [MLP] Compressed layer 16 to rank 5385 (Nyström, λ=0.01)
2025-05-05 21:49:30,674 - INFO - [MLP] Compressed layer 17 to rank 5464 (Nyström, λ=0.01)
2025-05-05 21:50:38,993 - INFO - [MLP] Compressed layer 18 to rank 5502 (Nyström, λ=0.01)
2025-05-05 21:51:46,895 - INFO - [MLP] Compressed layer 19 to rank 5568 (Nyström, λ=0.01)
2025-05-05 21:52:56,057 - INFO - [MLP] Compressed layer 20 to rank 5584 (Nyström, λ=0.01)
2025-05-05 21:54:05,625 - INFO - [MLP] Compressed layer 21 to rank 5646 (Nyström, λ=0.01)
2025-05-05 21:55:14,243 - INFO - [MLP] Compressed layer 22 to rank 5652 (Nyström, λ=0.01)
2025-05-05 21:56:24,411 - INFO - [MLP] Compressed layer 23 to rank 5691 (Nyström, λ=0.01)
2025-05-05 21:57:35,156 - INFO - [MLP] Compressed layer 24 to rank 5695 (Nyström, λ=0.01)
2025-05-05 21:58:45,126 - INFO - [MLP] Compressed layer 25 to rank 5695 (Nyström, λ=0.01)
2025-05-05 21:59:54,725 - INFO - [MLP] Compressed layer 26 to rank 5708 (Nyström, λ=0.01)
2025-05-05 22:01:04,643 - INFO - [MLP] Compressed layer 27 to rank 5714 (Nyström, λ=0.01)
2025-05-05 22:02:15,378 - INFO - [MLP] Compressed layer 28 to rank 5701 (Nyström, λ=0.01)
2025-05-05 22:03:24,103 - INFO - [MLP] Compressed layer 29 to rank 5690 (Nyström, λ=0.01)
2025-05-05 22:04:32,163 - INFO - [MLP] Compressed layer 30 to rank 5378 (Nyström, λ=0.01)
2025-05-05 22:05:29,035 - INFO - [MLP] Compressed layer 31 to rank 3896 (Nyström, λ=0.01)
2025-05-05 22:05:52,544 - INFO - [QK] Compressed layer 0 to rank 128 per head (ridge λ=0.01)
2025-05-05 22:06:15,130 - INFO - [QK] Compressed layer 1 to rank 48 per head (ridge λ=0.01)
2025-05-05 22:06:38,239 - INFO - [QK] Compressed layer 2 to rank 57 per head (ridge λ=0.01)
2025-05-05 22:07:00,045 - INFO - [QK] Compressed layer 3 to rank 58 per head (ridge λ=0.01)
2025-05-05 22:07:23,779 - INFO - [QK] Compressed layer 4 to rank 58 per head (ridge λ=0.01)
2025-05-05 22:07:46,677 - INFO - [QK] Compressed layer 5 to rank 59 per head (ridge λ=0.01)
2025-05-05 22:08:09,840 - INFO - [QK] Compressed layer 6 to rank 59 per head (ridge λ=0.01)
2025-05-05 22:08:33,273 - INFO - [QK] Compressed layer 7 to rank 59 per head (ridge λ=0.01)
2025-05-05 22:08:56,691 - INFO - [QK] Compressed layer 8 to rank 60 per head (ridge λ=0.01)
2025-05-05 22:09:20,351 - INFO - [QK] Compressed layer 9 to rank 61 per head (ridge λ=0.01)
2025-05-05 22:09:43,335 - INFO - [QK] Compressed layer 10 to rank 61 per head (ridge λ=0.01)
2025-05-05 22:10:07,169 - INFO - [QK] Compressed layer 11 to rank 62 per head (ridge λ=0.01)
2025-05-05 22:10:30,553 - INFO - [QK] Compressed layer 12 to rank 62 per head (ridge λ=0.01)
2025-05-05 22:10:53,945 - INFO - [QK] Compressed layer 13 to rank 62 per head (ridge λ=0.01)
2025-05-05 22:11:17,393 - INFO - [QK] Compressed layer 14 to rank 62 per head (ridge λ=0.01)
2025-05-05 22:11:41,068 - INFO - [QK] Compressed layer 15 to rank 62 per head (ridge λ=0.01)
2025-05-05 22:12:04,372 - INFO - [QK] Compressed layer 16 to rank 62 per head (ridge λ=0.01)
2025-05-05 22:12:27,901 - INFO - [QK] Compressed layer 17 to rank 63 per head (ridge λ=0.01)
2025-05-05 22:12:50,692 - INFO - [QK] Compressed layer 18 to rank 63 per head (ridge λ=0.01)
2025-05-05 22:13:13,908 - INFO - [QK] Compressed layer 19 to rank 64 per head (ridge λ=0.01)
2025-05-05 22:13:36,545 - INFO - [QK] Compressed layer 20 to rank 64 per head (ridge λ=0.01)
2025-05-05 22:13:59,844 - INFO - [QK] Compressed layer 21 to rank 65 per head (ridge λ=0.01)
2025-05-05 22:14:23,034 - INFO - [QK] Compressed layer 22 to rank 65 per head (ridge λ=0.01)
2025-05-05 22:14:46,573 - INFO - [QK] Compressed layer 23 to rank 66 per head (ridge λ=0.01)
2025-05-05 22:15:10,064 - INFO - [QK] Compressed layer 24 to rank 66 per head (ridge λ=0.01)
2025-05-05 22:15:32,758 - INFO - [QK] Compressed layer 25 to rank 66 per head (ridge λ=0.01)
2025-05-05 22:15:56,017 - INFO - [QK] Compressed layer 26 to rank 66 per head (ridge λ=0.01)
2025-05-05 22:16:19,427 - INFO - [QK] Compressed layer 27 to rank 66 per head (ridge λ=0.01)
2025-05-05 22:16:42,781 - INFO - [QK] Compressed layer 28 to rank 66 per head (ridge λ=0.01)
2025-05-05 22:17:06,034 - INFO - [QK] Compressed layer 29 to rank 66 per head (ridge λ=0.01)
2025-05-05 22:17:29,449 - INFO - [QK] Compressed layer 30 to rank 62 per head (ridge λ=0.01)
2025-05-05 22:17:52,618 - INFO - [QK] Compressed layer 31 to rank 45 per head (ridge λ=0.01)
2025-05-05 22:17:56,618 - INFO - [VO] ✅ Compressed layer 0 to rank 128 per head (λ=0.01)
2025-05-05 22:17:59,942 - INFO - [VO] ✅ Compressed layer 1 to rank 48 per head (λ=0.01)
2025-05-05 22:18:03,379 - INFO - [VO] ✅ Compressed layer 2 to rank 57 per head (λ=0.01)
2025-05-05 22:18:06,947 - INFO - [VO] ✅ Compressed layer 3 to rank 58 per head (λ=0.01)
2025-05-05 22:18:10,492 - INFO - [VO] ✅ Compressed layer 4 to rank 58 per head (λ=0.01)
2025-05-05 22:18:13,937 - INFO - [VO] ✅ Compressed layer 5 to rank 59 per head (λ=0.01)
2025-05-05 22:18:17,318 - INFO - [VO] ✅ Compressed layer 6 to rank 59 per head (λ=0.01)
2025-05-05 22:18:20,863 - INFO - [VO] ✅ Compressed layer 7 to rank 59 per head (λ=0.01)
2025-05-05 22:18:24,438 - INFO - [VO] ✅ Compressed layer 8 to rank 60 per head (λ=0.01)
2025-05-05 22:18:27,946 - INFO - [VO] ✅ Compressed layer 9 to rank 61 per head (λ=0.01)
2025-05-05 22:18:31,501 - INFO - [VO] ✅ Compressed layer 10 to rank 61 per head (λ=0.01)
2025-05-05 22:18:35,105 - INFO - [VO] ✅ Compressed layer 11 to rank 62 per head (λ=0.01)
2025-05-05 22:18:38,694 - INFO - [VO] ✅ Compressed layer 12 to rank 62 per head (λ=0.01)
2025-05-05 22:18:42,257 - INFO - [VO] ✅ Compressed layer 13 to rank 62 per head (λ=0.01)
2025-05-05 22:18:45,862 - INFO - [VO] ✅ Compressed layer 14 to rank 62 per head (λ=0.01)
2025-05-05 22:18:49,306 - INFO - [VO] ✅ Compressed layer 15 to rank 62 per head (λ=0.01)
2025-05-05 22:18:52,920 - INFO - [VO] ✅ Compressed layer 16 to rank 62 per head (λ=0.01)
2025-05-05 22:18:56,516 - INFO - [VO] ✅ Compressed layer 17 to rank 63 per head (λ=0.01)
2025-05-05 22:19:00,010 - INFO - [VO] ✅ Compressed layer 18 to rank 63 per head (λ=0.01)
2025-05-05 22:19:03,640 - INFO - [VO] ✅ Compressed layer 19 to rank 64 per head (λ=0.01)
2025-05-05 22:19:07,196 - INFO - [VO] ✅ Compressed layer 20 to rank 64 per head (λ=0.01)
2025-05-05 22:19:10,776 - INFO - [VO] ✅ Compressed layer 21 to rank 65 per head (λ=0.01)
2025-05-05 22:19:14,381 - INFO - [VO] ✅ Compressed layer 22 to rank 65 per head (λ=0.01)
2025-05-05 22:19:17,921 - INFO - [VO] ✅ Compressed layer 23 to rank 66 per head (λ=0.01)
2025-05-05 22:19:21,517 - INFO - [VO] ✅ Compressed layer 24 to rank 66 per head (λ=0.01)
2025-05-05 22:19:25,199 - INFO - [VO] ✅ Compressed layer 25 to rank 66 per head (λ=0.01)
2025-05-05 22:19:28,872 - INFO - [VO] ✅ Compressed layer 26 to rank 66 per head (λ=0.01)
2025-05-05 22:19:32,510 - INFO - [VO] ✅ Compressed layer 27 to rank 66 per head (λ=0.01)
2025-05-05 22:19:36,129 - INFO - [VO] ✅ Compressed layer 28 to rank 66 per head (λ=0.01)
2025-05-05 22:19:39,801 - INFO - [VO] ✅ Compressed layer 29 to rank 66 per head (λ=0.01)
2025-05-05 22:19:43,387 - INFO - [VO] ✅ Compressed layer 30 to rank 62 per head (λ=0.01)
2025-05-05 22:19:46,812 - INFO - [VO] ✅ Compressed layer 31 to rank 45 per head (λ=0.01)
2025-05-05 22:19:46,816 - INFO - Saving compressed model...
2025-05-05 22:21:53,866 - INFO - ✔ Model, tokenizer, and tokenizer_source.txt saved to /u/scratch/x/xxiong/compressed_output/llama2-7b
2025-05-05 22:21:53,868 - INFO - Reloading compressed model for evaluation...
2025-05-05 22:21:53,869 - INFO - Reloading compressed model from: /u/scratch/x/xxiong/compressed_output/llama2-7b
Loading checkpoint shards:   0%|          | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███▎      | 1/3 [00:00<00:00,  9.64it/s]Loading checkpoint shards:  67%|██████▋   | 2/3 [00:00<00:00,  9.75it/s]Loading checkpoint shards: 100%|██████████| 3/3 [00:01<00:00,  1.60it/s]Loading checkpoint shards: 100%|██████████| 3/3 [00:01<00:00,  2.07it/s]
2025-05-05 22:22:31,396 - INFO - ✔ Reloaded compressed model to cuda:1 successfully.
2025-05-05 22:22:57,733 - INFO - Compressed model perplexity on WikiText2: 6.50
