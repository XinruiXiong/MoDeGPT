2025-05-02 03:44:10,157 - INFO - Loading model: meta-llama/Llama-2-7b-hf
2025-05-02 03:44:10,158 - INFO - Loading model from: meta-llama/Llama-2-7b-hf
Downloading shards:   0%|          | 0/2 [00:00<?, ?it/s]Downloading shards:  50%|█████     | 1/2 [02:05<02:05, 125.24s/it]Downloading shards: 100%|██████████| 2/2 [03:05<00:00, 87.00s/it] Downloading shards: 100%|██████████| 2/2 [03:05<00:00, 92.73s/it]
Loading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards:  50%|█████     | 1/2 [00:39<00:39, 39.04s/it]Loading checkpoint shards: 100%|██████████| 2/2 [00:54<00:00, 25.12s/it]Loading checkpoint shards: 100%|██████████| 2/2 [00:54<00:00, 27.23s/it]
2025-05-02 03:49:23,128 - INFO - ✔ Loaded model on cuda:0 with float16.
2025-05-02 03:49:23,129 - INFO - No pad_token found. Set pad_token = eos_token.
2025-05-02 03:49:23,131 - INFO - Loading calibration and evaluation texts...
2025-05-02 03:49:34,598 - INFO - Evaluating original model (for baseline perplexity)...
2025-05-02 03:50:57,907 - INFO - Original model perplexity on WikiText2: 5.72
2025-05-02 03:50:57,908 - INFO - Calibrating model...
2025-05-02 03:50:57,908 - INFO - Detected architecture: llama
2025-05-02 03:52:19,386 - INFO - Finished calibration and computed BI scores.
2025-05-02 03:52:19,390 - INFO - Allocating layer sparsity...
2025-05-02 03:52:19,391 - INFO - Allocating global sparsity using target keep ratio 0.5000 and temperature 1.0
2025-05-02 03:52:19,391 - INFO - Layer  0: keep_ratio = 1.0000 (BI = 0.4532)
2025-05-02 03:52:19,391 - INFO - Layer  1: keep_ratio = 0.3774 (BI = 0.3471)
2025-05-02 03:52:19,391 - INFO - Layer  2: keep_ratio = 0.4513 (BI = 0.1683)
2025-05-02 03:52:19,391 - INFO - Layer  3: keep_ratio = 0.4585 (BI = 0.1526)
2025-05-02 03:52:19,391 - INFO - Layer  4: keep_ratio = 0.4563 (BI = 0.1575)
2025-05-02 03:52:19,391 - INFO - Layer  5: keep_ratio = 0.4629 (BI = 0.1431)
2025-05-02 03:52:19,391 - INFO - Layer  6: keep_ratio = 0.4640 (BI = 0.1407)
2025-05-02 03:52:19,391 - INFO - Layer  7: keep_ratio = 0.4671 (BI = 0.1339)
2025-05-02 03:52:19,391 - INFO - Layer  8: keep_ratio = 0.4736 (BI = 0.1201)
2025-05-02 03:52:19,391 - INFO - Layer  9: keep_ratio = 0.4782 (BI = 0.1105)
2025-05-02 03:52:19,391 - INFO - Layer 10: keep_ratio = 0.4819 (BI = 0.1027)
2025-05-02 03:52:19,391 - INFO - Layer 11: keep_ratio = 0.4873 (BI = 0.0916)
2025-05-02 03:52:19,391 - INFO - Layer 12: keep_ratio = 0.4869 (BI = 0.0925)
2025-05-02 03:52:19,391 - INFO - Layer 13: keep_ratio = 0.4864 (BI = 0.0936)
2025-05-02 03:52:19,391 - INFO - Layer 14: keep_ratio = 0.4904 (BI = 0.0853)
2025-05-02 03:52:19,391 - INFO - Layer 15: keep_ratio = 0.4856 (BI = 0.0952)
2025-05-02 03:52:19,391 - INFO - Layer 16: keep_ratio = 0.4893 (BI = 0.0876)
2025-05-02 03:52:19,391 - INFO - Layer 17: keep_ratio = 0.4964 (BI = 0.0731)
2025-05-02 03:52:19,391 - INFO - Layer 18: keep_ratio = 0.4998 (BI = 0.0663)
2025-05-02 03:52:19,391 - INFO - Layer 19: keep_ratio = 0.5058 (BI = 0.0543)
2025-05-02 03:52:19,391 - INFO - Layer 20: keep_ratio = 0.5073 (BI = 0.0514)
2025-05-02 03:52:19,391 - INFO - Layer 21: keep_ratio = 0.5130 (BI = 0.0403)
2025-05-02 03:52:19,391 - INFO - Layer 22: keep_ratio = 0.5135 (BI = 0.0393)
2025-05-02 03:52:19,391 - INFO - Layer 23: keep_ratio = 0.5170 (BI = 0.0324)
2025-05-02 03:52:19,391 - INFO - Layer 24: keep_ratio = 0.5174 (BI = 0.0317)
2025-05-02 03:52:19,391 - INFO - Layer 25: keep_ratio = 0.5174 (BI = 0.0317)
2025-05-02 03:52:19,391 - INFO - Layer 26: keep_ratio = 0.5186 (BI = 0.0295)
2025-05-02 03:52:19,391 - INFO - Layer 27: keep_ratio = 0.5191 (BI = 0.0284)
2025-05-02 03:52:19,391 - INFO - Layer 28: keep_ratio = 0.5180 (BI = 0.0306)
2025-05-02 03:52:19,391 - INFO - Layer 29: keep_ratio = 0.5170 (BI = 0.0326)
2025-05-02 03:52:19,391 - INFO - Layer 30: keep_ratio = 0.4886 (BI = 0.0890)
2025-05-02 03:52:19,391 - INFO - Layer 31: keep_ratio = 0.3540 (BI = 0.4112)
2025-05-02 03:52:19,391 - INFO - Freeing original model from GPU before compression...
2025-05-02 03:52:20,554 - INFO - n_layers=32, n_heads=32, d_model=4096, head_dim=128
2025-05-02 03:52:20,554 - INFO - Applying MoDeGPT compression methods...
2025-05-02 03:54:54,283 - INFO - [MLP] Compressed layer 0 to rank 11008 (Nyström, λ=0.01)
2025-05-02 03:55:45,191 - INFO - [MLP] Compressed layer 1 to rank 4154 (Nyström, λ=0.01)
2025-05-02 03:56:45,221 - INFO - [MLP] Compressed layer 2 to rank 4968 (Nyström, λ=0.01)
2025-05-02 03:57:49,796 - INFO - [MLP] Compressed layer 3 to rank 5046 (Nyström, λ=0.01)
2025-05-02 03:58:53,248 - INFO - [MLP] Compressed layer 4 to rank 5022 (Nyström, λ=0.01)
2025-05-02 03:59:51,884 - INFO - [MLP] Compressed layer 5 to rank 5095 (Nyström, λ=0.01)
2025-05-02 04:00:40,948 - INFO - [MLP] Compressed layer 6 to rank 5107 (Nyström, λ=0.01)
2025-05-02 04:01:36,636 - INFO - [MLP] Compressed layer 7 to rank 5142 (Nyström, λ=0.01)
2025-05-02 04:02:27,406 - INFO - [MLP] Compressed layer 8 to rank 5213 (Nyström, λ=0.01)
2025-05-02 04:03:27,456 - INFO - [MLP] Compressed layer 9 to rank 5264 (Nyström, λ=0.01)
2025-05-02 04:04:26,742 - INFO - [MLP] Compressed layer 10 to rank 5305 (Nyström, λ=0.01)
2025-05-02 04:05:25,803 - INFO - [MLP] Compressed layer 11 to rank 5364 (Nyström, λ=0.01)
2025-05-02 04:06:25,516 - INFO - [MLP] Compressed layer 12 to rank 5359 (Nyström, λ=0.01)
2025-05-02 04:07:24,514 - INFO - [MLP] Compressed layer 13 to rank 5354 (Nyström, λ=0.01)
2025-05-02 04:08:31,312 - INFO - [MLP] Compressed layer 14 to rank 5398 (Nyström, λ=0.01)
2025-05-02 04:09:37,879 - INFO - [MLP] Compressed layer 15 to rank 5345 (Nyström, λ=0.01)
2025-05-02 04:10:44,584 - INFO - [MLP] Compressed layer 16 to rank 5385 (Nyström, λ=0.01)
2025-05-02 04:11:46,801 - INFO - [MLP] Compressed layer 17 to rank 5464 (Nyström, λ=0.01)
2025-05-02 04:12:46,454 - INFO - [MLP] Compressed layer 18 to rank 5502 (Nyström, λ=0.01)
2025-05-02 04:13:48,235 - INFO - [MLP] Compressed layer 19 to rank 5568 (Nyström, λ=0.01)
2025-05-02 04:14:48,738 - INFO - [MLP] Compressed layer 20 to rank 5584 (Nyström, λ=0.01)
2025-05-02 04:15:56,367 - INFO - [MLP] Compressed layer 21 to rank 5646 (Nyström, λ=0.01)
2025-05-02 04:17:05,423 - INFO - [MLP] Compressed layer 22 to rank 5652 (Nyström, λ=0.01)
2025-05-02 04:18:14,956 - INFO - [MLP] Compressed layer 23 to rank 5691 (Nyström, λ=0.01)
2025-05-02 04:19:25,013 - INFO - [MLP] Compressed layer 24 to rank 5695 (Nyström, λ=0.01)
2025-05-02 04:20:13,161 - INFO - [MLP] Compressed layer 25 to rank 5695 (Nyström, λ=0.01)
2025-05-02 04:21:01,968 - INFO - [MLP] Compressed layer 26 to rank 5708 (Nyström, λ=0.01)
2025-05-02 04:22:05,480 - INFO - [MLP] Compressed layer 27 to rank 5714 (Nyström, λ=0.01)
2025-05-02 04:23:08,268 - INFO - [MLP] Compressed layer 28 to rank 5701 (Nyström, λ=0.01)
2025-05-02 04:24:14,740 - INFO - [MLP] Compressed layer 29 to rank 5690 (Nyström, λ=0.01)
2025-05-02 04:25:22,636 - INFO - [MLP] Compressed layer 30 to rank 5378 (Nyström, λ=0.01)
2025-05-02 04:26:20,628 - INFO - [MLP] Compressed layer 31 to rank 3896 (Nyström, λ=0.01)
2025-05-02 04:26:43,673 - INFO - [QK] Compressed layer 0 to rank 128 per head (ridge λ=0.01)
2025-05-02 04:27:06,929 - INFO - [QK] Compressed layer 1 to rank 48 per head (ridge λ=0.01)
2025-05-02 04:27:28,705 - INFO - [QK] Compressed layer 2 to rank 57 per head (ridge λ=0.01)
2025-05-02 04:27:49,112 - INFO - [QK] Compressed layer 3 to rank 58 per head (ridge λ=0.01)
2025-05-02 04:28:12,251 - INFO - [QK] Compressed layer 4 to rank 58 per head (ridge λ=0.01)
2025-05-02 04:28:35,365 - INFO - [QK] Compressed layer 5 to rank 59 per head (ridge λ=0.01)
2025-05-02 04:28:54,722 - INFO - [QK] Compressed layer 6 to rank 59 per head (ridge λ=0.01)
2025-05-02 04:29:17,920 - INFO - [QK] Compressed layer 7 to rank 59 per head (ridge λ=0.01)
2025-05-02 04:29:41,079 - INFO - [QK] Compressed layer 8 to rank 60 per head (ridge λ=0.01)
2025-05-02 04:30:00,617 - INFO - [QK] Compressed layer 9 to rank 61 per head (ridge λ=0.01)
2025-05-02 04:30:23,728 - INFO - [QK] Compressed layer 10 to rank 61 per head (ridge λ=0.01)
2025-05-02 04:30:46,435 - INFO - [QK] Compressed layer 11 to rank 62 per head (ridge λ=0.01)
2025-05-02 04:31:05,790 - INFO - [QK] Compressed layer 12 to rank 62 per head (ridge λ=0.01)
2025-05-02 04:31:28,908 - INFO - [QK] Compressed layer 13 to rank 62 per head (ridge λ=0.01)
2025-05-02 04:31:51,985 - INFO - [QK] Compressed layer 14 to rank 62 per head (ridge λ=0.01)
2025-05-02 04:32:12,768 - INFO - [QK] Compressed layer 15 to rank 62 per head (ridge λ=0.01)
2025-05-02 04:32:35,937 - INFO - [QK] Compressed layer 16 to rank 62 per head (ridge λ=0.01)
2025-05-02 04:32:59,016 - INFO - [QK] Compressed layer 17 to rank 63 per head (ridge λ=0.01)
2025-05-02 04:33:19,379 - INFO - [QK] Compressed layer 18 to rank 63 per head (ridge λ=0.01)
2025-05-02 04:33:42,471 - INFO - [QK] Compressed layer 19 to rank 64 per head (ridge λ=0.01)
2025-05-02 04:34:05,150 - INFO - [QK] Compressed layer 20 to rank 64 per head (ridge λ=0.01)
2025-05-02 04:34:25,846 - INFO - [QK] Compressed layer 21 to rank 65 per head (ridge λ=0.01)
2025-05-02 04:34:49,059 - INFO - [QK] Compressed layer 22 to rank 65 per head (ridge λ=0.01)
2025-05-02 04:35:11,892 - INFO - [QK] Compressed layer 23 to rank 66 per head (ridge λ=0.01)
2025-05-02 04:35:32,611 - INFO - [QK] Compressed layer 24 to rank 66 per head (ridge λ=0.01)
2025-05-02 04:35:55,848 - INFO - [QK] Compressed layer 25 to rank 66 per head (ridge λ=0.01)
2025-05-02 04:36:18,910 - INFO - [QK] Compressed layer 26 to rank 66 per head (ridge λ=0.01)
2025-05-02 04:36:39,744 - INFO - [QK] Compressed layer 27 to rank 66 per head (ridge λ=0.01)
2025-05-02 04:37:02,336 - INFO - [QK] Compressed layer 28 to rank 66 per head (ridge λ=0.01)
2025-05-02 04:37:21,892 - INFO - [QK] Compressed layer 29 to rank 66 per head (ridge λ=0.01)
2025-05-02 04:37:37,614 - INFO - [QK] Compressed layer 30 to rank 62 per head (ridge λ=0.01)
2025-05-02 04:37:57,447 - INFO - [QK] Compressed layer 31 to rank 45 per head (ridge λ=0.01)
2025-05-02 04:37:57,456 - WARNING - [VO] Compression failed at layer 0: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,457 - WARNING - [VO] Compression failed at layer 1: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,458 - WARNING - [VO] Compression failed at layer 2: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,458 - WARNING - [VO] Compression failed at layer 3: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,459 - WARNING - [VO] Compression failed at layer 4: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,459 - WARNING - [VO] Compression failed at layer 5: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,460 - WARNING - [VO] Compression failed at layer 6: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,461 - WARNING - [VO] Compression failed at layer 7: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,461 - WARNING - [VO] Compression failed at layer 8: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,462 - WARNING - [VO] Compression failed at layer 9: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,463 - WARNING - [VO] Compression failed at layer 10: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,463 - WARNING - [VO] Compression failed at layer 11: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,464 - WARNING - [VO] Compression failed at layer 12: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,465 - WARNING - [VO] Compression failed at layer 13: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,465 - WARNING - [VO] Compression failed at layer 14: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,466 - WARNING - [VO] Compression failed at layer 15: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,467 - WARNING - [VO] Compression failed at layer 16: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,467 - WARNING - [VO] Compression failed at layer 17: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,468 - WARNING - [VO] Compression failed at layer 18: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,468 - WARNING - [VO] Compression failed at layer 19: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,469 - WARNING - [VO] Compression failed at layer 20: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,470 - WARNING - [VO] Compression failed at layer 21: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,470 - WARNING - [VO] Compression failed at layer 22: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,471 - WARNING - [VO] Compression failed at layer 23: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,472 - WARNING - [VO] Compression failed at layer 24: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,473 - WARNING - [VO] Compression failed at layer 25: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,474 - WARNING - [VO] Compression failed at layer 26: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,474 - WARNING - [VO] Compression failed at layer 27: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,475 - WARNING - [VO] Compression failed at layer 28: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,476 - WARNING - [VO] Compression failed at layer 29: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,476 - WARNING - [VO] Compression failed at layer 30: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,477 - WARNING - [VO] Compression failed at layer 31: mat1 and mat2 shapes cannot be multiplied (4096x128 and 4096x128)
2025-05-02 04:37:57,477 - INFO - Saving compressed model...
2025-05-02 04:39:59,098 - INFO - ✔ Model, tokenizer, and tokenizer_source.txt saved to /u/scratch/x/xxiong/compressed_output/llama2-7b
2025-05-02 04:39:59,101 - INFO - Reloading compressed model for evaluation...
2025-05-02 04:39:59,101 - INFO - Reloading compressed model from: /u/scratch/x/xxiong/compressed_output/llama2-7b
Loading checkpoint shards:   0%|          | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███▎      | 1/3 [00:01<00:03,  1.75s/it]Loading checkpoint shards:  67%|██████▋   | 2/3 [00:01<00:00,  1.26it/s]Loading checkpoint shards: 100%|██████████| 3/3 [00:01<00:00,  2.07it/s]Loading checkpoint shards: 100%|██████████| 3/3 [00:01<00:00,  1.51it/s]
2025-05-02 04:40:48,594 - INFO - ✔ Reloaded compressed model to cuda:0 successfully.
2025-05-02 04:42:09,099 - INFO - Compressed model perplexity on WikiText2: 6.50
