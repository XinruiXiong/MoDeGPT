2025-05-04 04:47:35,436 - INFO - Loading model: meta-llama/Llama-2-7b-hf
2025-05-04 04:47:35,436 - INFO - Loading model from: meta-llama/Llama-2-7b-hf
Loading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards:  50%|█████     | 1/2 [00:00<00:00,  8.76it/s]Loading checkpoint shards: 100%|██████████| 2/2 [00:00<00:00,  9.58it/s]
2025-05-04 04:47:42,438 - INFO - ✔ Loaded model on cuda:0 with float16.
2025-05-04 04:47:42,439 - INFO - No pad_token found. Set pad_token = eos_token.
2025-05-04 04:47:42,440 - INFO - Loading calibration and evaluation texts...
2025-05-04 04:47:51,131 - INFO - Evaluating original model (for baseline perplexity)...
2025-05-04 04:48:18,966 - INFO - Original model perplexity on WikiText2: 5.72
2025-05-04 04:48:18,967 - INFO - Calibrating model...
2025-05-04 04:48:18,967 - INFO - Detected architecture: llama
2025-05-04 04:50:55,534 - INFO - Finished calibration and computed BI scores.
2025-05-04 04:50:55,537 - INFO - Allocating layer sparsity...
2025-05-04 04:50:55,537 - INFO - Allocating global sparsity using target keep ratio 0.5000 and temperature 1.0
2025-05-04 04:50:55,537 - INFO - Layer  0: keep_ratio = 1.0000 (BI = 0.4532)
2025-05-04 04:50:55,537 - INFO - Layer  1: keep_ratio = 0.3774 (BI = 0.3471)
2025-05-04 04:50:55,538 - INFO - Layer  2: keep_ratio = 0.4513 (BI = 0.1683)
2025-05-04 04:50:55,538 - INFO - Layer  3: keep_ratio = 0.4585 (BI = 0.1526)
2025-05-04 04:50:55,538 - INFO - Layer  4: keep_ratio = 0.4563 (BI = 0.1575)
2025-05-04 04:50:55,538 - INFO - Layer  5: keep_ratio = 0.4629 (BI = 0.1431)
2025-05-04 04:50:55,538 - INFO - Layer  6: keep_ratio = 0.4640 (BI = 0.1407)
2025-05-04 04:50:55,538 - INFO - Layer  7: keep_ratio = 0.4671 (BI = 0.1339)
2025-05-04 04:50:55,538 - INFO - Layer  8: keep_ratio = 0.4736 (BI = 0.1201)
2025-05-04 04:50:55,538 - INFO - Layer  9: keep_ratio = 0.4782 (BI = 0.1105)
2025-05-04 04:50:55,538 - INFO - Layer 10: keep_ratio = 0.4819 (BI = 0.1027)
2025-05-04 04:50:55,538 - INFO - Layer 11: keep_ratio = 0.4873 (BI = 0.0916)
2025-05-04 04:50:55,538 - INFO - Layer 12: keep_ratio = 0.4869 (BI = 0.0925)
2025-05-04 04:50:55,538 - INFO - Layer 13: keep_ratio = 0.4864 (BI = 0.0936)
2025-05-04 04:50:55,538 - INFO - Layer 14: keep_ratio = 0.4904 (BI = 0.0853)
2025-05-04 04:50:55,538 - INFO - Layer 15: keep_ratio = 0.4856 (BI = 0.0952)
2025-05-04 04:50:55,538 - INFO - Layer 16: keep_ratio = 0.4893 (BI = 0.0876)
2025-05-04 04:50:55,538 - INFO - Layer 17: keep_ratio = 0.4964 (BI = 0.0731)
2025-05-04 04:50:55,538 - INFO - Layer 18: keep_ratio = 0.4998 (BI = 0.0663)
2025-05-04 04:50:55,538 - INFO - Layer 19: keep_ratio = 0.5058 (BI = 0.0543)
2025-05-04 04:50:55,538 - INFO - Layer 20: keep_ratio = 0.5073 (BI = 0.0514)
2025-05-04 04:50:55,538 - INFO - Layer 21: keep_ratio = 0.5130 (BI = 0.0403)
2025-05-04 04:50:55,538 - INFO - Layer 22: keep_ratio = 0.5135 (BI = 0.0393)
2025-05-04 04:50:55,538 - INFO - Layer 23: keep_ratio = 0.5170 (BI = 0.0324)
2025-05-04 04:50:55,538 - INFO - Layer 24: keep_ratio = 0.5174 (BI = 0.0317)
2025-05-04 04:50:55,538 - INFO - Layer 25: keep_ratio = 0.5174 (BI = 0.0317)
2025-05-04 04:50:55,538 - INFO - Layer 26: keep_ratio = 0.5186 (BI = 0.0295)
2025-05-04 04:50:55,538 - INFO - Layer 27: keep_ratio = 0.5191 (BI = 0.0284)
2025-05-04 04:50:55,538 - INFO - Layer 28: keep_ratio = 0.5180 (BI = 0.0306)
2025-05-04 04:50:55,538 - INFO - Layer 29: keep_ratio = 0.5170 (BI = 0.0326)
2025-05-04 04:50:55,538 - INFO - Layer 30: keep_ratio = 0.4886 (BI = 0.0890)
2025-05-04 04:50:55,538 - INFO - Layer 31: keep_ratio = 0.3540 (BI = 0.4112)
2025-05-04 04:50:55,538 - INFO - Freeing original model from GPU before compression...
2025-05-04 04:50:59,360 - INFO - n_layers=32, n_heads=32, d_model=4096, head_dim=128
2025-05-04 04:50:59,360 - INFO - Applying MoDeGPT compression methods...
2025-05-04 04:51:34,390 - INFO - [MLP] Compressed layer 0 to rank 11008 (Nyström, λ=0.01)
2025-05-04 04:51:37,607 - INFO - [MLP] Compressed layer 1 to rank 4154 (Nyström, λ=0.01)
2025-05-04 04:51:42,244 - INFO - [MLP] Compressed layer 2 to rank 4968 (Nyström, λ=0.01)
2025-05-04 04:51:46,966 - INFO - [MLP] Compressed layer 3 to rank 5046 (Nyström, λ=0.01)
2025-05-04 04:51:51,417 - INFO - [MLP] Compressed layer 4 to rank 5022 (Nyström, λ=0.01)
2025-05-04 04:51:56,093 - INFO - [MLP] Compressed layer 5 to rank 5095 (Nyström, λ=0.01)
2025-05-04 04:52:00,797 - INFO - [MLP] Compressed layer 6 to rank 5107 (Nyström, λ=0.01)
2025-05-04 04:52:05,438 - INFO - [MLP] Compressed layer 7 to rank 5142 (Nyström, λ=0.01)
2025-05-04 04:52:10,460 - INFO - [MLP] Compressed layer 8 to rank 5213 (Nyström, λ=0.01)
2025-05-04 04:52:15,310 - INFO - [MLP] Compressed layer 9 to rank 5264 (Nyström, λ=0.01)
2025-05-04 04:52:20,654 - INFO - [MLP] Compressed layer 10 to rank 5305 (Nyström, λ=0.01)
2025-05-04 04:52:25,963 - INFO - [MLP] Compressed layer 11 to rank 5364 (Nyström, λ=0.01)
2025-05-04 04:52:31,440 - INFO - [MLP] Compressed layer 12 to rank 5359 (Nyström, λ=0.01)
2025-05-04 04:52:36,685 - INFO - [MLP] Compressed layer 13 to rank 5354 (Nyström, λ=0.01)
2025-05-04 04:52:42,126 - INFO - [MLP] Compressed layer 14 to rank 5398 (Nyström, λ=0.01)
2025-05-04 04:52:47,452 - INFO - [MLP] Compressed layer 15 to rank 5345 (Nyström, λ=0.01)
2025-05-04 04:52:52,850 - INFO - [MLP] Compressed layer 16 to rank 5385 (Nyström, λ=0.01)
2025-05-04 04:52:58,221 - INFO - [MLP] Compressed layer 17 to rank 5464 (Nyström, λ=0.01)
2025-05-04 04:53:04,037 - INFO - [MLP] Compressed layer 18 to rank 5502 (Nyström, λ=0.01)
2025-05-04 04:53:09,680 - INFO - [MLP] Compressed layer 19 to rank 5568 (Nyström, λ=0.01)
2025-05-04 04:53:15,566 - INFO - [MLP] Compressed layer 20 to rank 5584 (Nyström, λ=0.01)
2025-05-04 04:53:21,868 - INFO - [MLP] Compressed layer 21 to rank 5646 (Nyström, λ=0.01)
2025-05-04 04:53:28,013 - INFO - [MLP] Compressed layer 22 to rank 5652 (Nyström, λ=0.01)
2025-05-04 04:53:34,330 - INFO - [MLP] Compressed layer 23 to rank 5691 (Nyström, λ=0.01)
2025-05-04 04:53:40,839 - INFO - [MLP] Compressed layer 24 to rank 5695 (Nyström, λ=0.01)
2025-05-04 04:53:47,106 - INFO - [MLP] Compressed layer 25 to rank 5695 (Nyström, λ=0.01)
2025-05-04 04:53:53,293 - INFO - [MLP] Compressed layer 26 to rank 5708 (Nyström, λ=0.01)
2025-05-04 04:53:59,571 - INFO - [MLP] Compressed layer 27 to rank 5714 (Nyström, λ=0.01)
2025-05-04 04:54:06,053 - INFO - [MLP] Compressed layer 28 to rank 5701 (Nyström, λ=0.01)
2025-05-04 04:54:12,137 - INFO - [MLP] Compressed layer 29 to rank 5690 (Nyström, λ=0.01)
2025-05-04 04:54:17,867 - INFO - [MLP] Compressed layer 30 to rank 5378 (Nyström, λ=0.01)
2025-05-04 04:54:20,505 - INFO - [MLP] Compressed layer 31 to rank 3896 (Nyström, λ=0.01)
2025-05-04 04:54:21,185 - INFO - [QK] Compressed layer 0 to rank 128 per head (ridge λ=0.01)
2025-05-04 04:54:21,622 - INFO - [QK] Compressed layer 1 to rank 48 per head (ridge λ=0.01)
2025-05-04 04:54:22,046 - INFO - [QK] Compressed layer 2 to rank 57 per head (ridge λ=0.01)
2025-05-04 04:54:22,466 - INFO - [QK] Compressed layer 3 to rank 58 per head (ridge λ=0.01)
2025-05-04 04:54:22,890 - INFO - [QK] Compressed layer 4 to rank 58 per head (ridge λ=0.01)
2025-05-04 04:54:23,314 - INFO - [QK] Compressed layer 5 to rank 59 per head (ridge λ=0.01)
2025-05-04 04:54:23,737 - INFO - [QK] Compressed layer 6 to rank 59 per head (ridge λ=0.01)
2025-05-04 04:54:24,162 - INFO - [QK] Compressed layer 7 to rank 59 per head (ridge λ=0.01)
2025-05-04 04:54:24,582 - INFO - [QK] Compressed layer 8 to rank 60 per head (ridge λ=0.01)
2025-05-04 04:54:24,989 - INFO - [QK] Compressed layer 9 to rank 61 per head (ridge λ=0.01)
2025-05-04 04:54:25,350 - INFO - [QK] Compressed layer 10 to rank 61 per head (ridge λ=0.01)
2025-05-04 04:54:25,691 - INFO - [QK] Compressed layer 11 to rank 62 per head (ridge λ=0.01)
2025-05-04 04:54:26,002 - INFO - [QK] Compressed layer 12 to rank 62 per head (ridge λ=0.01)
2025-05-04 04:54:26,333 - INFO - [QK] Compressed layer 13 to rank 62 per head (ridge λ=0.01)
2025-05-04 04:54:26,690 - INFO - [QK] Compressed layer 14 to rank 62 per head (ridge λ=0.01)
2025-05-04 04:54:27,039 - INFO - [QK] Compressed layer 15 to rank 62 per head (ridge λ=0.01)
2025-05-04 04:54:27,389 - INFO - [QK] Compressed layer 16 to rank 62 per head (ridge λ=0.01)
2025-05-04 04:54:27,740 - INFO - [QK] Compressed layer 17 to rank 63 per head (ridge λ=0.01)
2025-05-04 04:54:28,086 - INFO - [QK] Compressed layer 18 to rank 63 per head (ridge λ=0.01)
2025-05-04 04:54:28,426 - INFO - [QK] Compressed layer 19 to rank 64 per head (ridge λ=0.01)
2025-05-04 04:54:28,780 - INFO - [QK] Compressed layer 20 to rank 64 per head (ridge λ=0.01)
2025-05-04 04:54:29,179 - INFO - [QK] Compressed layer 21 to rank 65 per head (ridge λ=0.01)
2025-05-04 04:54:29,566 - INFO - [QK] Compressed layer 22 to rank 65 per head (ridge λ=0.01)
2025-05-04 04:54:29,950 - INFO - [QK] Compressed layer 23 to rank 66 per head (ridge λ=0.01)
2025-05-04 04:54:30,332 - INFO - [QK] Compressed layer 24 to rank 66 per head (ridge λ=0.01)
2025-05-04 04:54:30,718 - INFO - [QK] Compressed layer 25 to rank 66 per head (ridge λ=0.01)
2025-05-04 04:54:31,100 - INFO - [QK] Compressed layer 26 to rank 66 per head (ridge λ=0.01)
2025-05-04 04:54:31,486 - INFO - [QK] Compressed layer 27 to rank 66 per head (ridge λ=0.01)
2025-05-04 04:54:31,861 - INFO - [QK] Compressed layer 28 to rank 66 per head (ridge λ=0.01)
2025-05-04 04:54:32,244 - INFO - [QK] Compressed layer 29 to rank 66 per head (ridge λ=0.01)
2025-05-04 04:54:32,586 - INFO - [QK] Compressed layer 30 to rank 62 per head (ridge λ=0.01)
2025-05-04 04:54:32,930 - INFO - [QK] Compressed layer 31 to rank 45 per head (ridge λ=0.01)
2025-05-04 04:54:33,434 - INFO - [VO] Compressed layer 0 to rank 128 per head (λ=0.01)
2025-05-04 04:54:33,744 - INFO - [VO] Compressed layer 1 to rank 48 per head (λ=0.01)
2025-05-04 04:54:34,062 - INFO - [VO] Compressed layer 2 to rank 57 per head (λ=0.01)
2025-05-04 04:54:34,302 - INFO - [VO] Compressed layer 3 to rank 58 per head (λ=0.01)
2025-05-04 04:54:34,527 - INFO - [VO] Compressed layer 4 to rank 58 per head (λ=0.01)
2025-05-04 04:54:34,805 - INFO - [VO] Compressed layer 5 to rank 59 per head (λ=0.01)
2025-05-04 04:54:35,093 - INFO - [VO] Compressed layer 6 to rank 59 per head (λ=0.01)
2025-05-04 04:54:35,375 - INFO - [VO] Compressed layer 7 to rank 59 per head (λ=0.01)
2025-05-04 04:54:35,653 - INFO - [VO] Compressed layer 8 to rank 60 per head (λ=0.01)
2025-05-04 04:54:35,932 - INFO - [VO] Compressed layer 9 to rank 61 per head (λ=0.01)
2025-05-04 04:54:36,210 - INFO - [VO] Compressed layer 10 to rank 61 per head (λ=0.01)
2025-05-04 04:54:36,495 - INFO - [VO] Compressed layer 11 to rank 62 per head (λ=0.01)
2025-05-04 04:54:36,780 - INFO - [VO] Compressed layer 12 to rank 62 per head (λ=0.01)
2025-05-04 04:54:37,060 - INFO - [VO] Compressed layer 13 to rank 62 per head (λ=0.01)
2025-05-04 04:54:37,343 - INFO - [VO] Compressed layer 14 to rank 62 per head (λ=0.01)
2025-05-04 04:54:37,640 - INFO - [VO] Compressed layer 15 to rank 62 per head (λ=0.01)
2025-05-04 04:54:37,944 - INFO - [VO] Compressed layer 16 to rank 62 per head (λ=0.01)
2025-05-04 04:54:38,257 - INFO - [VO] Compressed layer 17 to rank 63 per head (λ=0.01)
2025-05-04 04:54:38,564 - INFO - [VO] Compressed layer 18 to rank 63 per head (λ=0.01)
2025-05-04 04:54:38,878 - INFO - [VO] Compressed layer 19 to rank 64 per head (λ=0.01)
2025-05-04 04:54:39,182 - INFO - [VO] Compressed layer 20 to rank 64 per head (λ=0.01)
2025-05-04 04:54:39,533 - INFO - [VO] Compressed layer 21 to rank 65 per head (λ=0.01)
2025-05-04 04:54:39,876 - INFO - [VO] Compressed layer 22 to rank 65 per head (λ=0.01)
2025-05-04 04:54:40,231 - INFO - [VO] Compressed layer 23 to rank 66 per head (λ=0.01)
2025-05-04 04:54:40,589 - INFO - [VO] Compressed layer 24 to rank 66 per head (λ=0.01)
2025-05-04 04:54:40,948 - INFO - [VO] Compressed layer 25 to rank 66 per head (λ=0.01)
2025-05-04 04:54:41,306 - INFO - [VO] Compressed layer 26 to rank 66 per head (λ=0.01)
2025-05-04 04:54:41,703 - INFO - [VO] Compressed layer 27 to rank 66 per head (λ=0.01)
2025-05-04 04:54:42,077 - INFO - [VO] Compressed layer 28 to rank 66 per head (λ=0.01)
2025-05-04 04:54:42,425 - INFO - [VO] Compressed layer 29 to rank 66 per head (λ=0.01)
2025-05-04 04:54:42,732 - INFO - [VO] Compressed layer 30 to rank 62 per head (λ=0.01)
2025-05-04 04:54:43,035 - INFO - [VO] Compressed layer 31 to rank 45 per head (λ=0.01)
2025-05-04 04:54:43,035 - INFO - Saving compressed model...
2025-05-04 04:55:32,103 - ERROR - [Error] Failed to save model to /u/scratch/x/xxiong/compressed_output/llama2-7b: Error while serializing: IoError(Os { code: 2, kind: NotFound, message: "No such file or directory" })
Traceback (most recent call last):
  File "/u/home/x/xxiong/MoDeGPT/run_modegpt.py", line 355, in <module>
    main()
  File "/u/home/x/xxiong/MoDeGPT/run_modegpt.py", line 331, in main
    save_model(model, tokenizer, args.output_dir, source_model_name=args.model)
  File "/u/home/x/xxiong/MoDeGPT/model_utils.py", line 174, in save_model
    model.save_pretrained(save_dir, torch_dtype=torch.float16)
  File "/u/home/x/xxiong/miniforge3/envs/modegpt/lib/python3.10/site-packages/transformers/modeling_utils.py", line 2612, in save_pretrained
    safe_save_file(shard, os.path.join(save_directory, shard_file), metadata={"format": "pt"})
  File "/u/home/x/xxiong/miniforge3/envs/modegpt/lib/python3.10/site-packages/safetensors/torch.py", line 286, in save_file
    serialize_file(_flatten(tensors), filename, metadata=metadata)
safetensors_rust.SafetensorError: Error while serializing: IoError(Os { code: 2, kind: NotFound, message: "No such file or directory" })
