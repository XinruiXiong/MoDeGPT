2025-05-01 10:09:22,514 - INFO - Loading model: facebook/opt-6.7b
2025-05-01 10:09:22,514 - INFO - Loading model from: facebook/opt-6.7b
/u/home/x/xxiong/miniforge3/envs/modegpt/lib/python3.10/site-packages/huggingface_hub/file_download.py:896: FutureWarning: `resume_download` is deprecated and will be removed in version 1.0.0. Downloads always resume when possible. If you want to force a new download, use `force_download=True`.
  warnings.warn(
Downloading shards:   0%|          | 0/2 [00:00<?, ?it/s]Downloading shards:  50%|█████     | 1/2 [02:59<02:59, 179.89s/it]Downloading shards: 100%|██████████| 2/2 [03:59<00:00, 109.19s/it]Downloading shards: 100%|██████████| 2/2 [03:59<00:00, 119.80s/it]
2025-05-01 10:13:25,724 - WARNING - [Fallback] device_map='auto' failed: Device cuda:0 is not recognized, available devices are integers(for GPU/XPU), 'mps', 'cpu' and 'disk'
Loading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards:  50%|█████     | 1/2 [00:02<00:02,  2.56s/it]Loading checkpoint shards: 100%|██████████| 2/2 [00:03<00:00,  1.60s/it]Loading checkpoint shards: 100%|██████████| 2/2 [00:03<00:00,  1.75s/it]
2025-05-01 10:15:21,689 - INFO - ✔ Loaded with model.to(device) fallback.
2025-05-01 10:15:21,692 - INFO - Loading calibration and evaluation texts...
2025-05-01 10:15:31,574 - INFO - Evaluating original model (for baseline perplexity)...
2025-05-01 10:15:35,807 - INFO - Original model perplexity on WikiText2: 8.47
2025-05-01 10:15:35,807 - INFO - Calibrating model...
2025-05-01 10:15:35,807 - INFO - Detected architecture: opt
2025-05-01 10:16:08,239 - INFO - Finished calibration and computed BI scores.
2025-05-01 10:16:08,241 - INFO - Allocating layer sparsity...
2025-05-01 10:16:08,241 - INFO - Allocating global sparsity using target keep ratio 0.5000 and temperature 1.0
2025-05-01 10:16:08,241 - INFO - Layer  0: keep_ratio = 0.5000 (BI = -0.0000)
2025-05-01 10:16:08,241 - INFO - Layer  1: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer  2: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer  3: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer  4: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer  5: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer  6: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer  7: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer  8: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer  9: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 10: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 11: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 12: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 13: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 14: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 15: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 16: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 17: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 18: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 19: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 20: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 21: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 22: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 23: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 24: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 25: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 26: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 27: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 28: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 29: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 30: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Layer 31: keep_ratio = 0.5000 (BI = 0.0000)
2025-05-01 10:16:08,241 - INFO - Freeing original model from GPU before compression...
2025-05-01 10:16:11,981 - INFO - n_layers=32, n_heads=32, d_model=4096, head_dim=128
2025-05-01 10:16:11,981 - INFO - Applying MoDeGPT compression methods...
2025-05-01 10:17:15,308 - INFO - [MLP] Compressed layer 0 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:18:27,401 - INFO - [MLP] Compressed layer 1 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:19:46,229 - INFO - [MLP] Compressed layer 2 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:21:00,386 - INFO - [MLP] Compressed layer 3 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:22:19,408 - INFO - [MLP] Compressed layer 4 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:23:34,574 - INFO - [MLP] Compressed layer 5 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:24:57,884 - INFO - [MLP] Compressed layer 6 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:26:28,779 - INFO - [MLP] Compressed layer 7 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:28:05,663 - INFO - [MLP] Compressed layer 8 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:29:53,306 - INFO - [MLP] Compressed layer 9 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:31:48,969 - INFO - [MLP] Compressed layer 10 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:33:46,340 - INFO - [MLP] Compressed layer 11 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:35:39,930 - INFO - [MLP] Compressed layer 12 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:37:27,182 - INFO - [MLP] Compressed layer 13 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:39:03,934 - INFO - [MLP] Compressed layer 14 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:40:58,353 - INFO - [MLP] Compressed layer 15 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:42:52,437 - INFO - [MLP] Compressed layer 16 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:44:40,454 - INFO - [MLP] Compressed layer 17 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:46:21,431 - INFO - [MLP] Compressed layer 18 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:47:54,550 - INFO - [MLP] Compressed layer 19 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:49:22,923 - INFO - [MLP] Compressed layer 20 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:50:41,526 - INFO - [MLP] Compressed layer 21 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:51:56,062 - INFO - [MLP] Compressed layer 22 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:53:05,667 - INFO - [MLP] Compressed layer 23 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:54:21,614 - INFO - [MLP] Compressed layer 24 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:55:15,551 - INFO - [MLP] Compressed layer 25 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:56:06,639 - INFO - [MLP] Compressed layer 26 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:56:58,732 - INFO - [MLP] Compressed layer 27 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:57:51,298 - INFO - [MLP] Compressed layer 28 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:58:42,037 - INFO - [MLP] Compressed layer 29 to rank 8192 (Nyström, λ=0.01)
2025-05-01 10:59:21,217 - INFO - [MLP] Compressed layer 30 to rank 8192 (Nyström, λ=0.01)
2025-05-01 11:00:08,994 - INFO - [MLP] Compressed layer 31 to rank 8192 (Nyström, λ=0.01)
2025-05-01 11:00:14,907 - INFO - [QK] Compressed layer 0 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:00:21,178 - INFO - [QK] Compressed layer 1 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:00:27,328 - INFO - [QK] Compressed layer 2 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:00:32,833 - INFO - [QK] Compressed layer 3 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:00:38,382 - INFO - [QK] Compressed layer 4 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:00:44,338 - INFO - [QK] Compressed layer 5 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:00:51,296 - INFO - [QK] Compressed layer 6 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:00:56,822 - INFO - [QK] Compressed layer 7 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:01:01,522 - INFO - [QK] Compressed layer 8 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:01:06,967 - INFO - [QK] Compressed layer 9 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:01:12,030 - INFO - [QK] Compressed layer 10 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:01:17,204 - INFO - [QK] Compressed layer 11 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:01:22,776 - INFO - [QK] Compressed layer 12 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:01:28,248 - INFO - [QK] Compressed layer 13 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:01:34,239 - INFO - [QK] Compressed layer 14 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:01:40,181 - INFO - [QK] Compressed layer 15 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:01:46,149 - INFO - [QK] Compressed layer 16 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:01:52,202 - INFO - [QK] Compressed layer 17 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:01:57,747 - INFO - [QK] Compressed layer 18 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:02:02,406 - INFO - [QK] Compressed layer 19 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:02:08,819 - INFO - [QK] Compressed layer 20 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:02:15,046 - INFO - [QK] Compressed layer 21 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:02:21,625 - INFO - [QK] Compressed layer 22 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:02:27,149 - INFO - [QK] Compressed layer 23 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:02:33,081 - INFO - [QK] Compressed layer 24 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:02:39,329 - INFO - [QK] Compressed layer 25 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:02:45,711 - INFO - [QK] Compressed layer 26 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:02:52,563 - INFO - [QK] Compressed layer 27 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:02:59,412 - INFO - [QK] Compressed layer 28 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:03:05,935 - INFO - [QK] Compressed layer 29 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:03:12,297 - INFO - [QK] Compressed layer 30 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:03:17,297 - INFO - [QK] Compressed layer 31 to rank 64 per head (ridge λ=0.01)
2025-05-01 11:03:22,300 - INFO - [VO] Compressed layer 0 to rank 2048 (Type-III SVD)
2025-05-01 11:03:27,315 - INFO - [VO] Compressed layer 1 to rank 2048 (Type-III SVD)
2025-05-01 11:03:32,596 - INFO - [VO] Compressed layer 2 to rank 2048 (Type-III SVD)
2025-05-01 11:03:37,688 - INFO - [VO] Compressed layer 3 to rank 2048 (Type-III SVD)
2025-05-01 11:03:42,642 - INFO - [VO] Compressed layer 4 to rank 2048 (Type-III SVD)
2025-05-01 11:03:47,601 - INFO - [VO] Compressed layer 5 to rank 2048 (Type-III SVD)
2025-05-01 11:03:52,619 - INFO - [VO] Compressed layer 6 to rank 2048 (Type-III SVD)
2025-05-01 11:03:57,559 - INFO - [VO] Compressed layer 7 to rank 2048 (Type-III SVD)
2025-05-01 11:04:02,636 - INFO - [VO] Compressed layer 8 to rank 2048 (Type-III SVD)
2025-05-01 11:04:07,811 - INFO - [VO] Compressed layer 9 to rank 2048 (Type-III SVD)
2025-05-01 11:04:12,917 - INFO - [VO] Compressed layer 10 to rank 2048 (Type-III SVD)
2025-05-01 11:04:18,002 - INFO - [VO] Compressed layer 11 to rank 2048 (Type-III SVD)
2025-05-01 11:04:23,171 - INFO - [VO] Compressed layer 12 to rank 2048 (Type-III SVD)
2025-05-01 11:04:28,203 - INFO - [VO] Compressed layer 13 to rank 2048 (Type-III SVD)
2025-05-01 11:04:33,447 - INFO - [VO] Compressed layer 14 to rank 2048 (Type-III SVD)
2025-05-01 11:04:38,668 - INFO - [VO] Compressed layer 15 to rank 2048 (Type-III SVD)
2025-05-01 11:04:43,701 - INFO - [VO] Compressed layer 16 to rank 2048 (Type-III SVD)
2025-05-01 11:04:48,924 - INFO - [VO] Compressed layer 17 to rank 2048 (Type-III SVD)
2025-05-01 11:04:54,217 - INFO - [VO] Compressed layer 18 to rank 2048 (Type-III SVD)
2025-05-01 11:04:59,202 - INFO - [VO] Compressed layer 19 to rank 2048 (Type-III SVD)
2025-05-01 11:05:04,295 - INFO - [VO] Compressed layer 20 to rank 2048 (Type-III SVD)
2025-05-01 11:05:09,577 - INFO - [VO] Compressed layer 21 to rank 2048 (Type-III SVD)
2025-05-01 11:05:14,591 - INFO - [VO] Compressed layer 22 to rank 2048 (Type-III SVD)
2025-05-01 11:05:19,839 - INFO - [VO] Compressed layer 23 to rank 2048 (Type-III SVD)
2025-05-01 11:05:24,989 - INFO - [VO] Compressed layer 24 to rank 2048 (Type-III SVD)
2025-05-01 11:05:30,137 - INFO - [VO] Compressed layer 25 to rank 2048 (Type-III SVD)
2025-05-01 11:05:35,261 - INFO - [VO] Compressed layer 26 to rank 2048 (Type-III SVD)
2025-05-01 11:05:40,336 - INFO - [VO] Compressed layer 27 to rank 2048 (Type-III SVD)
2025-05-01 11:05:45,529 - INFO - [VO] Compressed layer 28 to rank 2048 (Type-III SVD)
2025-05-01 11:05:50,522 - INFO - [VO] Compressed layer 29 to rank 2048 (Type-III SVD)
2025-05-01 11:05:55,624 - INFO - [VO] Compressed layer 30 to rank 2048 (Type-III SVD)
2025-05-01 11:06:00,789 - INFO - [VO] Compressed layer 31 to rank 2048 (Type-III SVD)
2025-05-01 11:06:00,790 - INFO - Saving compressed model...
2025-05-01 11:08:05,505 - INFO - ✔ Model, tokenizer, and tokenizer_source.txt saved to compressed_output/opt-6.7b
2025-05-01 11:08:05,507 - INFO - Reloading compressed model for evaluation...
2025-05-01 11:08:05,507 - INFO - Reloading compressed model from: compressed_output/opt-6.7b
2025-05-01 11:08:11,039 - WARNING - [Reload fallback] device_map failed: Device cuda:0 is not recognized, available devices are integers(for GPU/XPU), 'mps', 'cpu' and 'disk'
Loading checkpoint shards:   0%|          | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███▎      | 1/3 [00:00<00:00,  8.63it/s]Loading checkpoint shards:  67%|██████▋   | 2/3 [00:00<00:00,  8.77it/s]Loading checkpoint shards: 100%|██████████| 3/3 [00:00<00:00,  8.98it/s]Loading checkpoint shards: 100%|██████████| 3/3 [00:00<00:00,  8.89it/s]
2025-05-01 11:08:16,298 - INFO - ✔ Reloaded compressed model and tokenizer successfully.
2025-05-01 11:08:20,033 - INFO - Compressed model perplexity on WikiText2: 3851.98
